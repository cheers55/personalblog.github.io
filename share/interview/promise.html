<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>🌈 手写 Promise | 🌈 程晓辉</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Personal Website">
    
    <link rel="preload" href="/assets/css/0.styles.f175d11a.css" as="style"><link rel="preload" href="/assets/js/app.bb2cc45c.js" as="script"><link rel="preload" href="/assets/js/2.661abb9a.js" as="script"><link rel="preload" href="/assets/js/39.c447da1a.js" as="script"><link rel="prefetch" href="/assets/js/10.c4fe3017.js"><link rel="prefetch" href="/assets/js/11.3e2c71bd.js"><link rel="prefetch" href="/assets/js/12.d4a94ab8.js"><link rel="prefetch" href="/assets/js/13.e081d157.js"><link rel="prefetch" href="/assets/js/14.a499d9d3.js"><link rel="prefetch" href="/assets/js/15.002997dd.js"><link rel="prefetch" href="/assets/js/16.667405e8.js"><link rel="prefetch" href="/assets/js/17.145e43ff.js"><link rel="prefetch" href="/assets/js/18.d5bb5f6a.js"><link rel="prefetch" href="/assets/js/19.d171e3f9.js"><link rel="prefetch" href="/assets/js/20.49797c96.js"><link rel="prefetch" href="/assets/js/21.2189bf11.js"><link rel="prefetch" href="/assets/js/22.7567fad1.js"><link rel="prefetch" href="/assets/js/23.03bffcec.js"><link rel="prefetch" href="/assets/js/24.6ecb55a4.js"><link rel="prefetch" href="/assets/js/25.847e675e.js"><link rel="prefetch" href="/assets/js/26.2f73d1c3.js"><link rel="prefetch" href="/assets/js/27.0764e1ce.js"><link rel="prefetch" href="/assets/js/28.0ac2f2c2.js"><link rel="prefetch" href="/assets/js/29.9a204645.js"><link rel="prefetch" href="/assets/js/3.bbe5046a.js"><link rel="prefetch" href="/assets/js/30.07f8425b.js"><link rel="prefetch" href="/assets/js/31.8182fad1.js"><link rel="prefetch" href="/assets/js/32.04267516.js"><link rel="prefetch" href="/assets/js/33.f766fc3c.js"><link rel="prefetch" href="/assets/js/34.da4e9fca.js"><link rel="prefetch" href="/assets/js/35.3cc015a2.js"><link rel="prefetch" href="/assets/js/36.f820fcb5.js"><link rel="prefetch" href="/assets/js/37.7ea6996e.js"><link rel="prefetch" href="/assets/js/38.f61d6739.js"><link rel="prefetch" href="/assets/js/4.d2be4349.js"><link rel="prefetch" href="/assets/js/40.34d552b3.js"><link rel="prefetch" href="/assets/js/41.af4ad5eb.js"><link rel="prefetch" href="/assets/js/42.91c92350.js"><link rel="prefetch" href="/assets/js/43.004ba8d0.js"><link rel="prefetch" href="/assets/js/44.4ed22e86.js"><link rel="prefetch" href="/assets/js/45.e6ca148a.js"><link rel="prefetch" href="/assets/js/46.41c29fbf.js"><link rel="prefetch" href="/assets/js/47.56e12f12.js"><link rel="prefetch" href="/assets/js/48.d254146c.js"><link rel="prefetch" href="/assets/js/5.e62e8fba.js"><link rel="prefetch" href="/assets/js/6.4a0603f6.js"><link rel="prefetch" href="/assets/js/7.379933d5.js"><link rel="prefetch" href="/assets/js/8.f1b74f63.js"><link rel="prefetch" href="/assets/js/9.eb26e27f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f175d11a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">🌈 程晓辉</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/share/" class="nav-link router-link-active">
  技术集
</a></div><div class="nav-item"><a href="/engineering/" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架
</a></div><div class="nav-item"><a href="/panClient/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/aboutMe/" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/share/" class="nav-link router-link-active">
  技术集
</a></div><div class="nav-item"><a href="/engineering/" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架
</a></div><div class="nav-item"><a href="/panClient/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/aboutMe/" class="nav-link">
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>🌈 手写 Promise</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/share/interview/promise.html#promise-基本特性" class="sidebar-link">Promise 基本特性</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/interview/promise.html#promise-优点" class="sidebar-link">Promise 优点</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/interview/promise.html#promise-缺点" class="sidebar-link">Promise 缺点</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/interview/promise.html#简单代码实现" class="sidebar-link">简单代码实现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/interview/promise.html#进阶版" class="sidebar-link">进阶版</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="🌈-手写-promise"><a href="#🌈-手写-promise" class="header-anchor">#</a> 🌈 手写 Promise</h1> <h2 id="promise-基本特性"><a href="#promise-基本特性" class="header-anchor">#</a> Promise 基本特性</h2> <ol><li>Promise 有三种状态：pending(进行中)、fulfilled(已成功)、rejected(已失败);</li> <li>Promise 对象接受一个回调函数作为参数, 该回调函数接受两个参数，分别是成功时的回调 resolve 和失败时的回调 reject；另外 resolve 的参数除了正常值以外， 还可能是一个 Promise 对象的实例；reject 的参数通常是一个 Error 对象的实例;</li> <li>then 方法返回一个新的 Promise 实例，并接收两个参数 onResolved(fulfilled 状态的回调)；onRejected(rejected 状态的回调，该参数可选);</li> <li>catch 方法返回一个新的 Promise 实例;</li> <li>finally 方法不管 Promise 状态如何都会执行，该方法的回调函数不接受任何参数;</li> <li>Promise.all()方法将多个多个 Promise 实例，包装成一个新的 Promise 实例，该方法接受一个由 Promise 对象组成的数组作为参数(Promise.all()方法的参数可以不是数组，但必须具有 Iterator 接口，且返回的每个成员都是 Promise 实例)，注意参数中只要有一个实例触发 catch 方法，都会触发 Promise.all()方法返回的新的实例的 catch 方法，如果参数中的某个实例本身调用了 catch 方法，将不会触发 Promise.all()方法返回的新实例的 catch 方法;</li> <li>Promise.race()方法的参数与 Promise.all 方法一样，参数中的实例只要有一个率先改变状态就会将该实例的状态传给 Promise.race()方法，并将返回值作为 Promise.race()方法产生的 Promise 实例的返回值;</li> <li>Promise.resolve()将现有对象转为 Promise 对象，如果该方法的参数为一个 Promise 对象，Promise.resolve()将不做任何处理；如果参数 thenable 对象(即具有 then 方法)，Promise.resolve()将该对象转为 Promise 对象并立即执行 then 方法；如果参数是一个原始值，或者是一个不具有 then 方法的对象，则 Promise.resolve 方法返回一个新的 Promise 对象，状态为 fulfilled，其参数将会作为 then 方法中 onResolved 回调函数的参数，如果 Promise.resolve 方法不带参数，会直接返回一个 fulfilled 状态的 Promise 对象。需要注意的是，立即 resolve()的 Promise 对象，是在本轮“事件循环”（event loop）的结束时执行，而不是在下一轮“事件循环”的开始时;</li> <li>Promise.reject()同样返回一个新的 Promise 对象，状态为 rejected，无论传入任何参数都将作为 reject()的参数;</li></ol> <h2 id="promise-优点"><a href="#promise-优点" class="header-anchor">#</a> Promise 优点</h2> <ol><li>Promise 的一个重要优点是它将逐渐被用作浏览器的异步 API ，统一现在各种各样的 API ，以及不兼容的模式和手法；</li> <li>和事件相比较， Promise 更适合处理一次性的结果。在结果计算出来之前或之后注册回调函数都是可以的，都可以拿到正确的值。 Promise 的这个优点很自然。但是，不能使用 Promise 处理多次触发的事件。链式处理是 Promise 的又一优点，但是事件却不能这样链式处理；</li> <li>解决了回调地狱的问题，将异步操作以同步操作的流程表达出来；</li> <li>Promise 带来的额外好处是包含了更好的错误处理方式（包含了异常处理），并且写起来很轻松（因为可以重用一些同步的工具，比如 Array.prototype.map() ）；</li></ol> <h2 id="promise-缺点"><a href="#promise-缺点" class="header-anchor">#</a> Promise 缺点</h2> <ol><li>无法取消 Promise，一旦新建它就会立即执行，无法中途取消；</li> <li>如果不设置回调函数，Promise 内部抛出的错误，不会反应到外部；</li> <li>当处于 Pending 状态时，无法得知目前进展到哪一个阶段（刚刚开始还是即将完成）；</li> <li>Promise 真正执行回调的时候，定义 Promise 那部分实际上已经走完了，所以 Promise 的报错堆栈上下文不太友好；</li></ol> <h2 id="简单代码实现"><a href="#简单代码实现" class="header-anchor">#</a> 简单代码实现</h2> <ul><li>最简单的 Promise 实现有 7 个主要属性, state(状态), value(成功返回值), reason(错误信息), resolve 方法, reject 方法, then 方法。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>class Promise{
  constructor(executor) {
    this.state = 'pending';
    this.value = undefined;
    this.reason = undefined;
    let resolve = value =&gt; {
      if (this.state === 'pending') {
        this.state = 'fulfilled';
        this.value = value;
      }
    };
    let reject = reason =&gt; {
      if (this.state === 'pending') {
        this.state = 'rejected';
        this.reason = reason;
      }
    };
    try {
      // 立即执行函数
      executor(resolve, reject);
    } catch (err) {
      reject(err);
    }
  }
  then(onFulfilled, onRejected) {
    if (this.state === 'fulfilled') {
      let x = onFulfilled(this.value);
    };
    if (this.state === 'rejected') {
      let x = onRejected(this.reason);
    };
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="进阶版"><a href="#进阶版" class="header-anchor">#</a> 进阶版</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>function myPromise(constructor){
  let self = this;
  this.status = &quot;pending&quot; //定义状态改变前的初始状态
  this.value = undefined; //定义状态为resolved的时候的状态
  this.reason = undefined; //定义状态为rejected的时候的状态

  // 成功
  function resolve(value){
    // 保证状态的改变是不不可逆的
    if(self.status === &quot;pending&quot;){
      self.value = value;
      self.status = &quot;resolved&quot;;
    }
  }

  // 失败
  function reject(reason){
     // 保证状态的改变是不不可逆的
     if(self.status === &quot;pending&quot;){
        self.reason = reason;
        self.status = &quot;rejected&quot;;
      }
  }

  //捕获构造异常
  try{
    constructor(resolve, reject);
  } catch(e){
    reject(e);
  }
}

myPromise.prototype.then = function(onFullfilled, onRejected){
  let self = this;
  switch(self.status){
    case &quot;resolved&quot;:
        onFullfilled(self.value);
        break;
    case &quot;rejected&quot;:
        onRejected(self.reason);
        break;
    default:
  }
}

// 测试
var prom = new myPromise(function(resolve, reject){
    resolve(1);
});
prom.then(function(res){
    console.log(res);
})
//输出1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bb2cc45c.js" defer></script><script src="/assets/js/2.661abb9a.js" defer></script><script src="/assets/js/39.c447da1a.js" defer></script>
  </body>
</html>
